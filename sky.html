<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Game Perang By fixa - Mobile V2</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      touch-action: none;
      user-select: none;
    }
    
    body {
      background: black;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
      height: 100vh;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      background-image: url('https://g.top4top.io/p_35020dbzs7.jpg');
      background-size: cover;
      background-position: center;
    }
    
    #gameContainer {
      position: relative;
      width: 100%;
      max-width: 500px;
      height: 85vh;
      max-height: 700px;
      margin: 0 auto;
      overflow: hidden;
      border: 3px solid #ff0000;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.7);
      border-radius: 15px;
    }
    
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
    }
    
    #scoreBoard {
      position: absolute;
      top: 15px;
      left: 0;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 24px;
      z-index: 5;
      text-shadow: 0 0 5px red;
    }
    
    #healthBar {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 20px;
      background: rgba(0,0,0,0.6);
      border: 2px solid #ff0000;
      border-radius: 10px;
      z-index: 5;
      overflow: hidden;
    }
    
    #healthFill {
      height: 100%;
      width: 100%;
      background: linear-gradient(to right, #ff0000, #ff6a00);
      transition: width 0.3s;
    }
    
    #levelInfo {
      position: absolute;
      top: 80px;
      left: 0;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 18px;
      z-index: 5;
      text-shadow: 0 0 5px red;
    }
    
    #powerUpIndicator {
      position: absolute;
      top: 110px;
      left: 0;
      width: 100%;
      text-align: center;
      color: yellow;
      font-size: 16px;
      z-index: 5;
      text-shadow: 0 0 5px orange;
      display: none;
    }
    
    /* Start Screen */
    #startScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      z-index: 20;
    }
    
    #startScreen h1 {
      font-size: 36px;
      margin-bottom: 20px;
      text-shadow: 0 0 10px red;
    }
    
    #startScreen p {
      font-size: 18px;
      margin-bottom: 30px;
      text-align: center;
      padding: 0 20px;
    }
    
    #startBtn {
      padding: 15px 30px;
      background: linear-gradient(145deg, #ff3333, #cc0000);
      border: none;
      border-radius: 15px;
      font-size: 24px;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
      transition: all 0.2s;
    }
    
    #startBtn:active {
      transform: scale(0.95);
    }
    
    #highScore {
      margin-top: 20px;
      font-size: 18px;
      color: yellow;
    }
    
    #gameOverScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      font-size: 32px;
      z-index: 10;
      text-shadow: 0 0 10px red;
      text-align: center;
    }
    
    #restartBtn {
      margin-top: 30px;
      padding: 15px 30px;
      background: linear-gradient(145deg, #ff3333, #cc0000);
      border: none;
      border-radius: 15px;
      font-size: 24px;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
      transition: all 0.2s;
    }
    
    #restartBtn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
<div id="gameContainer">
  <canvas id="gameCanvas"></canvas>
  
  <div id="scoreBoard">Skor: <span id="scoreValue">0</span></div>
  
  <div id="healthBar">
    <div id="healthFill"></div>
  </div>
  
  <div id="levelInfo">Level: <span id="levelValue">1</span></div>
  
  <div id="powerUpIndicator">Power Up Aktif!</div>
  
  <div id="gameOverScreen">
    <div>ðŸ’€ GAME OVER ðŸ’€</div>
    <div id="finalScore"></div>
    <div id="highScoreEnd"></div>
    <button id="restartBtn">Main Lagi</button>
  </div>
  
  <div id="startScreen">
    <h1>GAME PERANG V2</h1>
    <p>Kontrol pesawatmu dan hancurkan semua musuh!<br>Kumpulkan power-up untuk meningkatkan kemampuanmu!</p>
    <button id="startBtn">MULAI</button>
    <div id="highScore">High Score: <span id="highScoreValue">0</span></div>
  </div>
</div>
<!-- Audio elements -->
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="shootSound" src="shoot.wav"></audio>
<audio id="hitSound" src="hit.wav"></audio>
<audio id="explosionSound" src="explosion.wav"></audio>
<audio id="powerUpSound" src="powerup.wav"></audio>
<audio id="levelUpSound" src="levelup.wav"></audio>
<script>
const canvas = document.getElementById("gameCanvas");
const container = document.getElementById("gameContainer");
const startScreen = document.getElementById("startScreen");
const startBtn = document.getElementById("startBtn");
const gameOverScreen = document.getElementById("gameOverScreen");
const restartBtn = document.getElementById("restartBtn");
const highScoreElement = document.getElementById("highScoreValue");
const highScoreEndElement = document.getElementById("highScoreEnd");
const levelElement = document.getElementById("levelValue");
const powerUpIndicator = document.getElementById("powerUpIndicator");
// Atur ukuran canvas berdasarkan container
canvas.width = container.clientWidth;
canvas.height = container.clientHeight;
const ctx = canvas.getContext("2d");
// High Score dari localStorage
let highScore = localStorage.getItem("gameHighScore") || 0;
highScoreElement.textContent = highScore;
// Preload gambar yang masih diperlukan
const images = {
  bullet: new Image(),
  enemyBullet: new Image(),
  explosion: new Image(),
  playerShip: new Image(),
  enemyType1: new Image(),  // Tambahkan gambar untuk musuh tipe 1
  enemyType2: new Image()   // Tambahkan gambar untuk musuh tipe 2
};
images.bullet.src = "https://j.top4top.io/p_35028zye30.png";
images.enemyBullet.src = "https://h.top4top.io/p_350278yz40.png";
images.explosion.src = "https://k.top4top.io/p_35028m2w41.png";
images.playerShip.src = "https://d.top4top.io/p_3507yechr0.png";
// Menggunakan link gambar musuh yang diberikan
images.enemyType1.src = "https://a.top4top.io/p_350713mx60.png";  // Link gambar musuh tipe 1
images.enemyType2.src = "https://a.top4top.io/p_350713mx60.png";  // Link gambar musuh tipe 2
const shootSound = document.getElementById("shootSound");
const hitSound = document.getElementById("hitSound");
const explosionSound = document.getElementById("explosionSound");
const powerUpSound = document.getElementById("powerUpSound");
const levelUpSound = document.getElementById("levelUpSound");
// Ukuran relatif terhadap lebar canvas
const getRelativeSize = (percent) => canvas.width * (percent / 100);
// Karakter dengan ukuran responsif - UKURAN SAMA DENGAN MUSUH
let player = {
  x: canvas.width / 2 - getRelativeSize(8) / 2,
  y: canvas.height * 0.7,
  width: getRelativeSize(8),
  height: getRelativeSize(8),
  speed: getRelativeSize(0.7),
  lives: 100,
  moveLeft: false,
  moveRight: false,
  powerUps: {}, // Objek untuk menyimpan power-up aktif
};
let bullets = [];
let enemies = [];
let explosions = [];
let enemyBullets = [];
let boss = null;
let powerUps = [];
let score = 0;
let level = 1;
let lastShot = 0;
let gameOver = false;
let gameStarted = false;
let imagesLoaded = 0;
const totalImages = Object.keys(images).length;
let enemySpawnRate = 1000; // Default spawn rate
let lastEnemySpawn = 0;
// Batasan maksimum objek untuk mencegah memory leak
const MAX_BULLETS = 50;
const MAX_ENEMIES = 20;
const MAX_EXPLOSIONS = 10;
const MAX_ENEMY_BULLETS = 30;
const MAX_POWER_UPS = 5;
// Background luar angkasa
let stars = [];
let nebulae = [];
let backgroundOffset = 0;
// Inisialisasi bintang untuk background
function initStars() {
  stars = [];
  // Buat bintang dengan berbagai ukuran dan kecepatan
  for (let i = 0; i < 100; i++) {
    stars.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      size: Math.random() * 2 + 0.5,
      speed: Math.random() * 1 + 0.2,
      brightness: Math.random() * 0.5 + 0.5
    });
  }
}
// Inisialisasi nebula untuk background
function initNebulae() {
  nebulae = [];
  // Buat beberapa nebula
  for (let i = 0; i < 3; i++) {
    nebulae.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      radius: Math.random() * 150 + 100,
      color: `hsla(${Math.random() * 60 + 200}, 80%, 50%, 0.1)`
    });
  }
}
// Tombol kontrol di canvas
let buttons = {
  left: {
    x: 30,
    y: canvas.height - 90,
    width: 70,
    height: 70,
    radius: 35,
    color: '#ff1a1a',
    active: false
  },
  right: {
    x: canvas.width - 100,
    y: canvas.height - 90,
    width: 70,
    height: 70,
    radius: 35,
    color: '#ff1a1a',
    active: false
  },
  shoot: {
    x: canvas.width / 2 - 40,
    y: canvas.height - 90,
    width: 80,
    height: 80,
    radius: 40,
    color: '#ff9900',
    active: false,
    firing: false
  }
};
// Status sentuh untuk multi-touch
let touchStatus = {
  left: false,
  right: false,
  shoot: false,
  touchPoints: {} // Menyimpan ID sentuh dan tombol yang terkait
};
// Fungsi untuk menggambar tombol di canvas
function drawButtons() {
  // Tombol kiri
  drawButton(buttons.left, 'left');
  
  // Tombol kanan
  drawButton(buttons.right, 'right');
  
  // Tombol tembak
  drawButton(buttons.shoot, 'shoot');
}
// Fungsi untuk menggambar satu tombol
function drawButton(button, type) {
  ctx.save();
  
  // Efek bayangan
  ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
  ctx.shadowBlur = 10;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 5;
  
  // Gambar tombol
  ctx.beginPath();
  ctx.arc(button.x + button.width/2, button.y + button.height/2, button.radius, 0, Math.PI * 2);
  
  // Gradien untuk tombol
  const gradient = ctx.createRadialGradient(
    button.x + button.width/2, button.y + button.height/2, 0,
    button.x + button.width/2, button.y + button.height/2, button.radius
  );
  
  if (button.active) {
    gradient.addColorStop(0, button.color);
    gradient.addColorStop(1, '#990000');
  } else {
    gradient.addColorStop(0, button.color);
    gradient.addColorStop(1, '#cc0000');
  }
  
  ctx.fillStyle = gradient;
  ctx.fill();
  
  // Border
  ctx.strokeStyle = button.active ? '#ff3333' : '#ff3333';
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // Efek cahaya dalam
  ctx.beginPath();
  ctx.arc(button.x + button.width/2, button.y + button.height/2, button.radius - 5, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
  ctx.lineWidth = 1;
  ctx.stroke();
  
  // Ikon untuk tombol
  ctx.fillStyle = 'white';
  ctx.strokeStyle = 'white';
  ctx.lineWidth = 4;
  
  if (type === 'left') {
    // Ikon panah kiri
    ctx.beginPath();
    ctx.moveTo(button.x + button.width * 0.7, button.y + button.height * 0.3);
    ctx.lineTo(button.x + button.width * 0.3, button.y + button.height * 0.5);
    ctx.lineTo(button.x + button.width * 0.7, button.y + button.height * 0.7);
    ctx.stroke();
  } else if (type === 'right') {
    // Ikon panah kanan
    ctx.beginPath();
    ctx.moveTo(button.x + button.width * 0.3, button.y + button.height * 0.3);
    ctx.lineTo(button.x + button.width * 0.7, button.y + button.height * 0.5);
    ctx.lineTo(button.x + button.width * 0.3, button.y + button.height * 0.7);
    ctx.stroke();
  } else if (type === 'shoot') {
    // Ikon peluru
    ctx.beginPath();
    ctx.arc(button.x + button.width/2, button.y + button.height/2, button.width * 0.2, 0, Math.PI * 2);
    ctx.fill();
    
    // Efek tembakan
    if (button.firing) {
      ctx.beginPath();
      ctx.arc(button.x + button.width/2, button.y + button.height/2, button.radius + 10, 0, Math.PI * 2);
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
      ctx.lineWidth = 3;
      ctx.stroke();
    }
  }
  
  ctx.restore();
}
// Fungsi untuk menggambar background luar angkasa
function drawBackground() {
  // Gambar gradien background
  const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
  gradient.addColorStop(0, '#000011');
  gradient.addColorStop(0.5, '#000033');
  gradient.addColorStop(1, '#000011');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Gambar nebula
  for (const nebula of nebulae) {
    const gradient = ctx.createRadialGradient(
      nebula.x, nebula.y, 0,
      nebula.x, nebula.y, nebula.radius
    );
    gradient.addColorStop(0, nebula.color);
    gradient.addColorStop(1, 'transparent');
    
    ctx.fillStyle = gradient;
    ctx.fillRect(
      nebula.x - nebula.radius,
      nebula.y - nebula.radius,
      nebula.radius * 2,
      nebula.radius * 2
    );
  }
  
  // Gambar bintang
  for (const star of stars) {
    // Update posisi bintang
    star.y += star.speed;
    
    // Reset posisi bintang jika keluar dari layar
    if (star.y > canvas.height) {
      star.y = 0;
      star.x = Math.random() * canvas.width;
    }
    
    // Gambar bintang
    ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`;
    ctx.beginPath();
    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
    ctx.fill();
    
    // Tambahkan efek glow untuk bintang besar
    if (star.size > 1.5) {
      ctx.beginPath();
      ctx.arc(star.x, star.y, star.size * 2, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness * 0.3})`;
      ctx.fill();
    }
  }
  
  // Update offset untuk efek parallax
  backgroundOffset += 0.1;
  if (backgroundOffset > canvas.height) {
    backgroundOffset = 0;
  }
}
// Fungsi untuk memulai game
function startGame() {
  // Reset variabel game - UKURAN SAMA DENGAN MUSUH
  player = {
    x: canvas.width / 2 - getRelativeSize(8) / 2,
    y: canvas.height * 0.7,
    width: getRelativeSize(8),
    height: getRelativeSize(8),
    speed: getRelativeSize(0.7),
    lives: 100,
    moveLeft: false,
    moveRight: false,
    powerUps: {}, // Kosongkan objek power-ups
  };
  
  // Kosongkan semua array
  bullets = [];
  enemies = [];
  explosions = [];
  enemyBullets = [];
  boss = null;
  powerUps = [];
  
  score = 0;
  level = 1;
  lastShot = 0;
  gameOver = false;
  enemySpawnRate = 1000;
  lastEnemySpawn = 0;
  
  // Reset status tombol
  buttons.left.active = false;
  buttons.right.active = false;
  buttons.shoot.active = false;
  buttons.shoot.firing = false;
  
  // Reset status sentuh
  touchStatus = {
    left: false,
    right: false,
    shoot: false,
    touchPoints: {}
  };
  
  // Inisialisasi background
  initStars();
  initNebulae();
  
  // Update UI
  document.getElementById("scoreValue").textContent = score;
  document.getElementById("levelValue").textContent = level;
  document.getElementById("healthFill").style.width = "100%";
  powerUpIndicator.style.display = "none";
  
  // Sembunyikan start screen
  startScreen.style.display = "none";
  
  // Mulai game loop
  gameStarted = true;
  gameLoop();
}
// Cek apakah semua gambar sudah dimuat
function checkAllImagesLoaded() {
  imagesLoaded++;
  if (imagesLoaded === totalImages) {
    // Gambar siap, tapi tunggu tombol start ditekan
  }
}
// Set event listener untuk setiap gambar
Object.values(images).forEach(img => {
  img.onload = checkAllImagesLoaded;
  img.onerror = () => {
    console.error('Gagal memuat gambar:', img.src);
    checkAllImagesLoaded();
  };
});
// Event listener untuk tombol start
startBtn.addEventListener('click', startGame);
restartBtn.addEventListener('click', () => {
  gameOverScreen.style.display = "none";
  startGame();
});
// Fungsi untuk menggambar pesawat pemain dengan gambar eksternal
function drawPlayer() {
  const x = player.x;
  const y = player.y;
  const w = player.width;
  const h = player.height;
  
  // Gunakan gambar jika sudah dimuat
  if (images.playerShip.complete) {
    // Simpan state canvas saat ini
    ctx.save();
    
    // Atur komposit mode untuk menghapus warna hitam
    ctx.globalCompositeOperation = 'source-over';
    
    // Buat clipping path berbentuk pesawat
    ctx.beginPath();
    ctx.moveTo(x + w/2, y);
    ctx.lineTo(x + w, y + h/2);
    ctx.lineTo(x + w, y + h);
    ctx.lineTo(x + w/2, y + h*0.8);
    ctx.lineTo(x, y + h);
    ctx.lineTo(x, y + h/2);
    ctx.closePath();
    ctx.clip();
    
    // Gambar gambar pesawat
    ctx.drawImage(images.playerShip, x, y, w, h);
    
    // Kembalikan state canvas
    ctx.restore();
  } else {
    // Fallback jika gambar tidak dimuat - gambar pesawat dengan path
    // Badan pesawat (merah)
    ctx.fillStyle = '#ff0000';
    ctx.beginPath();
    ctx.moveTo(x + w/2, y);
    ctx.lineTo(x + w, y + h/2);
    ctx.lineTo(x + w, y + h);
    ctx.lineTo(x + w/2, y + h*0.8);
    ctx.lineTo(x, y + h);
    ctx.lineTo(x, y + h/2);
    ctx.closePath();
    ctx.fill();
    
    // Sayap pesawat (hitam)
    ctx.fillStyle = '#000000';
    ctx.beginPath();
    ctx.moveTo(x + w/2, y + h*0.4);
    ctx.lineTo(x + w*1.2, y + h*0.6);
    ctx.lineTo(x + w*1.2, y + h*0.8);
    ctx.lineTo(x + w/2, y + h*0.6);
    ctx.closePath();
    ctx.fill();
    
    ctx.beginPath();
    ctx.moveTo(x + w/2, y + h*0.4);
    ctx.lineTo(x - w*0.2, y + h*0.6);
    ctx.lineTo(x - w*0.2, y + h*0.8);
    ctx.lineTo(x + w/2, y + h*0.6);
    ctx.closePath();
    ctx.fill();
    
    // Kabin pesawat (hitam)
    ctx.fillStyle = '#000000';
    ctx.beginPath();
    ctx.moveTo(x + w*0.4, y + h*0.2);
    ctx.lineTo(x + w*0.6, y + h*0.2);
    ctx.lineTo(x + w*0.6, y + h*0.4);
    ctx.lineTo(x + w*0.4, y + h*0.4);
    ctx.closePath();
    ctx.fill();
    
    // Mesin pesawat (merah)
    ctx.fillStyle = '#ff0000';
    ctx.beginPath();
    ctx.arc(x + w*0.3, y + h*0.9, w*0.1, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(x + w*0.7, y + h*0.9, w*0.1, 0, Math.PI * 2);
    ctx.fill();
  }
  
  // Gambar efek power-up jika aktif
  if (player.powerUps.rapidfire || player.powerUps.shield) {
    // Jika ada rapid fire, gambar efek merah
    if (player.powerUps.rapidfire) {
      ctx.strokeStyle = '#ff0000';
      ctx.lineWidth = 3;
      ctx.strokeRect(x - 5, y - 5, w + 10, h + 10);
    }
    
    // Jika ada shield, gambar efek cyan
    if (player.powerUps.shield) {
      ctx.strokeStyle = '#00ffff';
      ctx.lineWidth = 2;
      ctx.strokeRect(x - 8, y - 8, w + 16, h + 16);
    }
  }
}
// Fungsi untuk menggambar musuh dengan gambar eksternal
function drawEnemies() {
  for (let i = enemies.length - 1; i >= 0; i--) {
    const e = enemies[i];
    
    // Gunakan gambar eksternal jika sudah dimuat
    if (e.type === 1 && images.enemyType1.complete) {
      ctx.drawImage(images.enemyType1, e.x, e.y, e.width, e.height);
    } else if (e.type === 2 && images.enemyType2.complete) {
      ctx.drawImage(images.enemyType2, e.x, e.y, e.width, e.height);
    } else {
      // Fallback jika gambar tidak dimuat
      if (e.type === 1) {
        drawEnemyType1(e.x, e.y, e.width, e.height);
      } else if (e.type === 2) {
        drawEnemyType2(e.x, e.y, e.width, e.height);
      }
    }
    
    // Gerakkan musuh
    if (e.movementPattern === 'straight') {
      e.y += e.speed;
    } else if (e.movementPattern === 'zigzag') {
      e.y += e.speed;
      e.x += Math.sin(e.y * 0.05) * 2;
    }
    
    // Musuh menembak secara acak
    if (Math.random() < 0.005) {
      // Batasi jumlah enemy bullets
      if (enemyBullets.length < MAX_ENEMY_BULLETS) {
        enemyBullets.push({ 
          x: e.x + e.width/2 - getRelativeSize(1.5), 
          y: e.y + e.height, 
          width: getRelativeSize(3),
          height: getRelativeSize(6),
          speed: getRelativeSize(1)
        });
      }
    }
    
    // Hapus musuh yang keluar dari layar
    if (e.y > canvas.height) {
      enemies.splice(i, 1);
    }
  }
}
// Fungsi untuk menggambar musuh tipe 1 (fallback)
function drawEnemyType1(x, y, w, h) {
  // Badan musuh (hijau)
  ctx.fillStyle = '#00ff00';
  ctx.beginPath();
  ctx.moveTo(x + w/2, y + h);
  ctx.lineTo(x + w, y);
  ctx.lineTo(x + w/2, y + h*0.3);
  ctx.lineTo(x, y);
  ctx.closePath();
  ctx.fill();
  
  // Kabin musuh (kuning)
  ctx.fillStyle = '#ffff00';
  ctx.beginPath();
  ctx.arc(x + w/2, y + h*0.5, w*0.15, 0, Math.PI * 2);
  ctx.fill();
  
  // Sayap musuh (hijau tua)
  ctx.fillStyle = '#008800';
  ctx.beginPath();
  ctx.moveTo(x + w*0.3, y + h*0.4);
  ctx.lineTo(x - w*0.1, y + h*0.6);
  ctx.lineTo(x + w*0.3, y + h*0.6);
  ctx.closePath();
  ctx.fill();
  
  ctx.beginPath();
  ctx.moveTo(x + w*0.7, y + h*0.4);
  ctx.lineTo(x + w*1.1, y + h*0.6);
  ctx.lineTo(x + w*0.7, y + h*0.6);
  ctx.closePath();
    ctx.fill();
}
// Fungsi untuk menggambar musuh tipe 2 (fallback)
function drawEnemyType2(x, y, w, h) {
  // Badan musuh (biru)
  ctx.fillStyle = '#0080ff';
  ctx.beginPath();
  ctx.ellipse(x + w/2, y + h/2, w*0.4, h*0.3, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Kepala musuh (biru tua)
  ctx.fillStyle = '#004080';
  ctx.beginPath();
  ctx.arc(x + w/2, y + h*0.3, w*0.2, 0, Math.PI * 2);
  ctx.fill();
  
  // Mata musuh (merah)
  ctx.fillStyle = '#ff0000';
  ctx.beginPath();
  ctx.arc(x + w*0.4, y + h*0.25, w*0.05, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.arc(x + w*0.6, y + h*0.25, w*0.05, 0, Math.PI * 2);
  ctx.fill();
  
  // Sayap musuh (biru muda)
  ctx.fillStyle = '#40a0ff';
  ctx.beginPath();
  ctx.moveTo(x + w*0.2, y + h*0.5);
  ctx.lineTo(x - w*0.1, y + h*0.3);
  ctx.lineTo(x - w*0.1, y + h*0.7);
  ctx.lineTo(x + w*0.2, y + h*0.5);
  ctx.closePath();
  ctx.fill();
  
  ctx.beginPath();
  ctx.moveTo(x + w*0.8, y + h*0.5);
  ctx.lineTo(x + w*1.1, y + h*0.3);
  ctx.lineTo(x + w*1.1, y + h*0.7);
  ctx.lineTo(x + w*0.8, y + h*0.5);
  ctx.closePath();
  ctx.fill();
  
  // Ekor musuh (biru tua)
  ctx.fillStyle = '#004080';
  ctx.beginPath();
  ctx.moveTo(x + w*0.4, y + h*0.7);
  ctx.lineTo(x + w*0.3, y + h);
  ctx.lineTo(x + w*0.7, y + h);
  ctx.lineTo(x + w*0.6, y + h*0.7);
  ctx.closePath();
  ctx.fill();
}
// Fungsi untuk menggambar boss alien raksasa
function drawBossAlien(x, y, w, h) {
  // Badan alien (hijau)
  ctx.fillStyle = '#00ff00';
  ctx.beginPath();
  ctx.ellipse(x + w/2, y + h*0.6, w*0.4, h*0.3, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Kepala alien (hijau muda)
  ctx.fillStyle = '#80ff80';
  ctx.beginPath();
  ctx.arc(x + w/2, y + h*0.3, w*0.25, 0, Math.PI * 2);
  ctx.fill();
  
  // Mata alien besar (hitam)
  ctx.fillStyle = '#000000';
  ctx.beginPath();
  ctx.arc(x + w*0.4, y + h*0.25, w*0.08, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.arc(x + w*0.6, y + h*0.25, w*0.08, 0, Math.PI * 2);
  ctx.fill();
  
  // Pupil mata (merah)
  ctx.fillStyle = '#ff0000';
  ctx.beginPath();
  ctx.arc(x + w*0.4, y + h*0.25, w*0.04, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.arc(x + w*0.6, y + h*0.25, w*0.04, 0, Math.PI * 2);
  ctx.fill();
  
  // Antena alien (hijau tua)
  ctx.strokeStyle = '#008000';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(x + w*0.35, y + h*0.15);
  ctx.lineTo(x + w*0.3, y);
  ctx.stroke();
  
  ctx.beginPath();
  ctx.moveTo(x + w*0.65, y + h*0.15);
  ctx.lineTo(x + w*0.7, y);
  ctx.stroke();
  
  // Bola antena (merah)
  ctx.fillStyle = '#ff0000';
  ctx.beginPath();
  ctx.arc(x + w*0.3, y, w*0.05, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.arc(x + w*0.7, y, w*0.05, 0, Math.PI * 2);
  ctx.fill();
  
  // Tangan alien (hijau)
  ctx.fillStyle = '#00ff00';
  ctx.beginPath();
  ctx.ellipse(x + w*0.15, y + h*0.5, w*0.08, h*0.15, -Math.PI/4, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.ellipse(x + w*0.85, y + h*0.5, w*0.08, h*0.15, Math.PI/4, 0, Math.PI * 2);
  ctx.fill();
  
  // Kaki alien (hijau tua)
  ctx.fillStyle = '#008000';
  ctx.beginPath();
  ctx.ellipse(x + w*0.3, y + h*0.9, w*0.1, h*0.15, 0, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.ellipse(x + w*0.7, y + h*0.9, w*0.1, h*0.15, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Pesawat alien di belakang (abu-abu)
  ctx.fillStyle = '#808080';
  ctx.beginPath();
  ctx.ellipse(x + w/2, y + h*1.2, w*0.6, h*0.2, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Jendela pesawat (biru)
  ctx.fillStyle = '#0080ff';
  ctx.beginPath();
  ctx.ellipse(x + w*0.3, y + h*1.2, w*0.1, h*0.05, 0, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.ellipse(x + w*0.7, y + h*1.2, w*0.1, h*0.05, 0, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.ellipse(x + w/2, y + h*1.2, w*0.15, h*0.05, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Lampu pesawat (kuning)
  ctx.fillStyle = '#ffff00';
  ctx.beginPath();
  ctx.arc(x + w*0.2, y + h*1.15, w*0.03, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.arc(x + w*0.8, y + h*1.15, w*0.03, 0, Math.PI * 2);
  ctx.fill();
}
function drawBoss() {
  if (!boss) return;
  
  drawBossAlien(boss.x, boss.y, boss.width, boss.height);
  
  boss.y += 0.3;
  
  // Health bar boss
  ctx.fillStyle = "black";
  ctx.fillRect(boss.x, boss.y - 15, boss.width, 12);
  ctx.fillStyle = "red";
  ctx.fillRect(boss.x, boss.y - 15, boss.width * (boss.hp / boss.maxHp), 12);
  
  // Boss menembak secara acak
  if (Math.random() < 0.02) {
    // Batasi jumlah enemy bullets
    if (enemyBullets.length < MAX_ENEMY_BULLETS) {
      enemyBullets.push({ 
        x: boss.x + boss.width / 2 - getRelativeSize(1.5), 
        y: boss.y + boss.height, 
        width: getRelativeSize(3),
        height: getRelativeSize(6),
        speed: getRelativeSize(1.2)
      });
    }
  }
}
function drawBullets() {
  for (let i = bullets.length - 1; i >= 0; i--) {
    const b = bullets[i];
    b.y -= b.speed;
    
    if (images.bullet.complete) {
      ctx.drawImage(images.bullet, b.x, b.y, b.width, b.height);
    } else {
      // Fallback jika gambar tidak dimuat
      ctx.fillStyle = 'yellow';
      ctx.fillRect(b.x, b.y, b.width, b.height);
    }
    
    // Hapus peluru yang keluar dari layar
    if (b.y + b.height < 0) {
      bullets.splice(i, 1);
    }
  }
}
function drawEnemyBullets() {
  for (let i = enemyBullets.length - 1; i >= 0; i--) {
    const b = enemyBullets[i];
    b.y += b.speed;
    
    if (images.enemyBullet.complete) {
      ctx.drawImage(images.enemyBullet, b.x, b.y, b.width, b.height);
    } else {
      // Fallback jika gambar tidak dimuat
      ctx.fillStyle = 'orange';
      ctx.fillRect(b.x, b.y, b.width, b.height);
    }
    
    // Hapus peluru yang keluar dari layar
    if (b.y > canvas.height) {
      enemyBullets.splice(i, 1);
    }
  }
}
function drawPowerUps() {
  for (let i = powerUps.length - 1; i >= 0; i--) {
    const p = powerUps[i];
    p.y += p.speed;
    p.rotation += 0.05;
    
    ctx.save();
    ctx.translate(p.x + p.size/2, p.y + p.size/2);
    ctx.rotate(p.rotation);
    
    if (p.type === 'rapidfire') {
      // Gambar power-up rapid fire dengan warna merah
      ctx.fillStyle = '#ff0000';
      ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
      
      // Tambahkan efek untuk menunjukkan tembakan cepat
      ctx.fillStyle = '#ffff00';
      ctx.fillRect(-p.size/4, -p.size/4, p.size/2, p.size/2);
      
      // Tambahkan garis untuk menunjukkan arah tembakan
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(-p.size/3, 0);
      ctx.lineTo(p.size/3, 0);
      ctx.moveTo(0, -p.size/3);
      ctx.lineTo(0, p.size/3);
      ctx.stroke();
    } else if (p.type === 'shield') {
      // Gambar power-up shield dengan bentuk perisai
      ctx.fillStyle = '#00ffff';
      
      // Gambar bentuk perisai
      ctx.beginPath();
      ctx.moveTo(0, -p.size/2);
      ctx.lineTo(p.size/2, -p.size/4);
      ctx.lineTo(p.size/2, p.size/4);
      ctx.lineTo(0, p.size/2);
      ctx.lineTo(-p.size/2, p.size/4);
      ctx.lineTo(-p.size/2, -p.size/4);
      ctx.closePath();
      ctx.fill();
      
      // Tambahkan efek cahaya
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 2;
      ctx.stroke();
    } else {
      // Fallback jika gambar tidak dimuat
      ctx.fillStyle = 'yellow';
      ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
    }
    
    ctx.restore();
    
    // Hapus power-up yang keluar dari layar
    if (p.y > canvas.height) {
      powerUps.splice(i, 1);
    }
  }
}
function drawExplosions() {
  for (let i = explosions.length - 1; i >= 0; i--) {
    const ex = explosions[i];
    
    if (images.explosion.complete) {
      ctx.drawImage(images.explosion, ex.x, ex.y, ex.size, ex.size);
    } else {
      // Fallback jika gambar tidak dimuat
      ctx.fillStyle = 'rgba(255, 100, 0, 0.7)';
      ctx.beginPath();
      ctx.arc(ex.x + ex.size/2, ex.y + ex.size/2, ex.size/2, 0, Math.PI * 2);
      ctx.fill();
    }
    
    ex.frame--;
    if (ex.frame <= 0) {
      explosions.splice(i, 1);
    }
  }
}
// Fungsi untuk memainkan suara dengan error handling yang lebih baik
function playSound(sound) {
  try {
    // Clone the audio element to allow multiple plays
    const soundClone = sound.cloneNode();
    soundClone.volume = 0.5;
    soundClone.play().catch(e => {
      console.log("Audio play error:", e);
    });
  } catch (e) {
    console.log("Audio error:", e);
  }
}
function checkCollisions() {
  // Cek tabrakan peluru pemain dengan musuh - PERBAIKAN UTAMA
  for (let bi = bullets.length - 1; bi >= 0; bi--) {
    const b = bullets[bi];
    
    // Simpan indeks musuh yang akan dihapus untuk menghindari masalah iterasi
    const enemiesToRemove = [];
    
    for (let ei = 0; ei < enemies.length; ei++) {
      const e = enemies[ei];
      if (b.x < e.x + e.width && 
          b.x + b.width > e.x && 
          b.y < e.y + e.height && 
          b.y + b.height > e.y) {
        
        // Tandai musuh untuk dihapus
        enemiesToRemove.push(ei);
        
        // Tandai peluru untuk dihapus
        bullets.splice(bi, 1);
        
        // Update skor
        score += e.type === 1 ? 1 : 2;
        document.getElementById("scoreValue").textContent = score;
        
        break; // Keluar dari loop musuh karena peluru sudah mengenai satu musuh
      }
    }
    
    // Hapus musuh yang ditandai dan tambahkan ledakan
    for (let i = enemiesToRemove.length - 1; i >= 0; i--) {
      const ei = enemiesToRemove[i];
      const e = enemies[ei];
      
      // Batasi jumlah explosions
      if (explosions.length < MAX_EXPLOSIONS) {
        explosions.push({ 
          x: e.x - e.width/2, 
          y: e.y - e.height/2, 
          size: e.width * 1.5,
          frame: 15 
        });
      }
      
      // Mainkan suara ledakan
      playSound(explosionSound);
      
      // Hapus musuh dari array
      enemies.splice(ei, 1);
    }
  }
  
  // Cek tabrakan dengan boss
  for (let bi = bullets.length - 1; bi >= 0; bi--) {
    const b = bullets[bi];
    
    if (boss && 
        b.x < boss.x + boss.width && 
        b.x + b.width > boss.x && 
        b.y < boss.y + boss.height && 
        b.y + b.height > boss.y) {
      
      boss.hp--;
      playSound(hitSound);
      
      // Batasi jumlah explosions
      if (explosions.length < MAX_EXPLOSIONS) {
        explosions.push({ 
          x: b.x - b.width, 
          y: b.y - b.height, 
          size: b.width * 4,
          frame: 12 
        });
      }
      
      bullets.splice(bi, 1);
      
      if (boss.hp <= 0) {
        // Batasi jumlah explosions
        if (explosions.length < MAX_EXPLOSIONS) {
          explosions.push({ 
            x: boss.x - boss.width/2, 
            y: boss.y - boss.height/2, 
            size: boss.width * 1.5,
            frame: 30 
          });
        }
        
        playSound(explosionSound);
        boss = null;
        score += 20;
        document.getElementById("scoreValue").textContent = score;
      }
    }
  }
  
  // Cek tabrakan pemain dengan power-up
  for (let i = powerUps.length - 1; i >= 0; i--) {
    const p = powerUps[i];
    if (p.x < player.x + player.width && 
        p.x + p.size > player.x && 
        p.y < player.y + player.height && 
        p.y + p.size > player.y) {
      
      powerUps.splice(i, 1);
      activatePowerUp(p.type);
    }
  }
  
  // Cek tabrakan peluru musuh dengan pemain
  for (let bi = enemyBullets.length - 1; bi >= 0; bi--) {
    const b = enemyBullets[bi];
    if (b.x < player.x + player.width && 
        b.x + b.width > player.x && 
        b.y < player.y + player.height && 
        b.y + b.height > player.y) {
      
      enemyBullets.splice(bi, 1);
      
      // Jika player memiliki shield, kurangi damage
      const damage = player.powerUps.shield ? 2 : 5;
      player.lives -= damage;
      
      // Pastikan health tidak kurang dari 0
      player.lives = Math.max(0, player.lives);
      
      document.getElementById("healthFill").style.width = player.lives + '%';
      playSound(hitSound);
      
      // Batasi jumlah explosions
      if (explosions.length < MAX_EXPLOSIONS) {
        explosions.push({ 
          x: player.x - player.width/2, 
          y: player.y - player.height/2, 
          size: player.width * 1.5,
          frame: 10 
        });
      }
      
      if (player.lives <= 0) {
        endGame();
      }
    }
  }
}
function activatePowerUp(type) {
  // Tambahkan power-up ke objek player.powerUps
  player.powerUps[type] = {
    time: 300 // 5 detik pada 60fps
  };
  
  // Update indikator power-up
  updatePowerUpIndicator();
  
  playSound(powerUpSound);
}
function updatePowerUpIndicator() {
  const activePowerUps = [];
  
  if (player.powerUps.rapidfire) {
    activePowerUps.push("Rapid Fire");
  }
  
  if (player.powerUps.shield) {
    activePowerUps.push("Shield");
  }
  
  if (activePowerUps.length > 0) {
    powerUpIndicator.style.display = "block";
    powerUpIndicator.textContent = `Power Up: ${activePowerUps.join(" & ")} Aktif!`;
  } else {
    powerUpIndicator.style.display = "none";
  }
}
function updatePowerUps() {
  // Update semua power-up aktif
  for (const powerUpType in player.powerUps) {
    if (player.powerUps[powerUpType].time > 0) {
      player.powerUps[powerUpType].time--;
      
      // Hapus power-up jika waktu habis
      if (player.powerUps[powerUpType].time === 0) {
        delete player.powerUps[powerUpType];
      }
    }
  }
  
  // Update indikator power-up
  updatePowerUpIndicator();
}
function updatePlayerPosition() {
  // Mengurangi kecepatan pergerakan agar lebih halus
  const moveSpeed = player.speed * 0.8;
  
  if (player.moveLeft && player.x > 0) {
    player.x -= moveSpeed;
  }
  
  if (player.moveRight && player.x + player.width < canvas.width) {
    player.x += moveSpeed;
  }
}
function shoot() {
  // Cek apakah sudah dalam cooldown
  let now = Date.now();
  let fireRate = player.powerUps.rapidfire ? 100 : 300; // Lebih cepat jika ada power-up rapidfire
  
  if (now - lastShot < fireRate) {
    return; // Masih dalam cooldown, jangan tembak
  }
  
  // Update last shot time
  lastShot = now;
  
  // Efek visual untuk tombol tembak
  buttons.shoot.firing = true;
  setTimeout(() => {
    buttons.shoot.firing = false;
  }, 500);
  
  // Batasi jumlah bullets
  if (bullets.length >= MAX_BULLETS) {
    // Hapus peluru tertua jika sudah mencapai batas maksimum
    bullets.shift();
  }
  
  // Tambahkan satu peluru default
  bullets.push({ 
    x: player.x + player.width/2 - getRelativeSize(1.5), 
    y: player.y, 
    width: getRelativeSize(3),
    height: getRelativeSize(6),
    speed: getRelativeSize(2)
  });
  
  // Jika ada power-up rapid fire, tambahkan peluru ekstra
  if (player.powerUps.rapidfire) {
    // Batasi jumlah bullets
    if (bullets.length < MAX_BULLETS - 2) {
      bullets.push({ 
        x: player.x + player.width/4 - getRelativeSize(1.5), 
        y: player.y, 
        width: getRelativeSize(3),
        height: getRelativeSize(6),
        speed: getRelativeSize(2)
      });
      bullets.push({ 
        x: player.x + 3*player.width/4 - getRelativeSize(1.5), 
        y: player.y, 
        width: getRelativeSize(3),
        height: getRelativeSize(6),
        speed: getRelativeSize(2)
      });
    }
  }
  
  // Mainkan suara tembakan
  playSound(shootSound);
}
function spawnEnemy() {
  if (gameOver || !gameStarted) return;
  
  const now = Date.now();
  if (now - lastEnemySpawn < enemySpawnRate) return;
  
  lastEnemySpawn = now;
  
  // Batasi jumlah enemies
  if (enemies.length >= MAX_ENEMIES) {
    return; // Jangan spawn musuh baru jika sudah mencapai batas maksimum
  }
  
  // Tentukan jenis musuh berdasarkan level
  const enemyType = Math.random() < 0.7 ? 1 : 2; // 70% musuh tipe 1, 30% musuh tipe 2
  
  const size = getRelativeSize(8);
  enemies.push({ 
    x: Math.random() * (canvas.width - size), 
    y: -size, 
    width: size,
    height: size,
    speed: getRelativeSize(0.3 + (level * 0.05)) + Math.random() * getRelativeSize(0.1),
    type: enemyType,
    movementPattern: Math.random() < 0.7 ? 'straight' : 'zigzag' // 70% lurus, 30% zigzag
  });
  
  // Spawn power-up secara acak
  if (Math.random() < 0.05) { // 5% chance
    // Batasi jumlah power-ups
    if (powerUps.length < MAX_POWER_UPS) {
      const powerUpType = Math.random() < 0.5 ? 'rapidfire' : 'shield';
      powerUps.push({
        x: Math.random() * (canvas.width - getRelativeSize(5)),
        y: -getRelativeSize(5),
        size: getRelativeSize(5),
        speed: getRelativeSize(0.2),
        type: powerUpType,
        rotation: 0
      });
    }
  }
}
function checkLevelUp() {
  const newLevel = Math.floor(score / 10) + 1;
  
  if (newLevel > level) {
    level = newLevel;
    document.getElementById("levelValue").textContent = level;
    
    // Tingkatkan kesulitan
    enemySpawnRate = Math.max(500, 1000 - (level * 50)); // Semakin cepat spawn musuh
    
    // Mainkan suara level up
    playSound(levelUpSound);
    
    // Spawn boss setiap 5 level
    if (level % 5 === 0 && !boss) {
      const size = getRelativeSize(25);
      boss = {
        x: canvas.width/2 - size/2,
        y: -size,
        width: size,
        height: size,
        hp: 20 + (level * 5),
        maxHp: 20 + (level * 5)
      };
    }
  }
}
function endGame() {
  gameOver = true;
  
  // Update high score
  if (score > highScore) {
    highScore = score;
    localStorage.setItem("gameHighScore", highScore);
    highScoreEndElement.textContent = `NEW HIGH SCORE: ${highScore}!`;
  } else {
    highScoreEndElement.textContent = `High Score: ${highScore}`;
  }
  
  document.getElementById("gameOverScreen").style.display = "flex";
  document.getElementById("finalScore").innerText = `Skor Akhir: ${score}`;
}
function gameLoop() {
  if (gameOver || !gameStarted) return;
  
  // Bersihkan canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Gambar background
  drawBackground();
  
  // Update dan gambar semua objek
  updatePlayerPosition();
  drawPlayer();
  drawEnemies();
  drawBoss();
  drawBullets();
  drawEnemyBullets();
  drawPowerUps();
  drawExplosions();
  
  // Gambar tombol kontrol
  drawButtons();
  
  // Cek tabrakan
  checkCollisions();
  
  // Update power-ups
  updatePowerUps();
  
  // Cek level up
  checkLevelUp();
  
  // Spawn musuh secara berkala - dipindahkan ke sini untuk kontrol yang lebih baik
  spawnEnemy();
  
  // Lanjutkan game loop
  requestAnimationFrame(gameLoop);
}
// Fungsi untuk menangani event sentuh pada canvas
function handleTouchStart(e) {
  e.preventDefault();
  
  const rect = canvas.getBoundingClientRect();
  
  // Proses semua sentuhan yang aktif
  for (let i = 0; i < e.touches.length; i++) {
    const touch = e.touches[i];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    const touchId = touch.identifier;
    
    // Cek tombol kiri
    if (isPointInButton(x, y, buttons.left)) {
      player.moveLeft = true;
      buttons.left.active = true;
      touchStatus.left = true;
      touchStatus.touchPoints[touchId] = 'left';
    }
    
    // Cek tombol kanan
    if (isPointInButton(x, y, buttons.right)) {
      player.moveRight = true;
      buttons.right.active = true;
      touchStatus.right = true;
      touchStatus.touchPoints[touchId] = 'right';
    }
    
    // Cek tombol tembak
    if (isPointInButton(x, y, buttons.shoot)) {
      buttons.shoot.active = true;
      touchStatus.shoot = true;
      touchStatus.touchPoints[touchId] = 'shoot';
      shoot();
    }
  }
}
// Fungsi untuk menangani event sentuh bergerak pada canvas
function handleTouchMove(e) {
  e.preventDefault();
  
  const rect = canvas.getBoundingClientRect();
  
  // Proses semua sentuhan yang aktif
  for (let i = 0; i < e.touches.length; i++) {
    const touch = e.touches[i];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    const touchId = touch.identifier;
    
    // Cek apakah sentuhan ini sudah terdaftar
    const buttonType = touchStatus.touchPoints[touchId];
    
    if (buttonType) {
      // Jika sentuhan sudah terdaftar, perbarui statusnya
      if (buttonType === 'left') {
        if (isPointInButton(x, y, buttons.left)) {
          if (!buttons.left.active) {
            player.moveLeft = true;
            buttons.left.active = true;
            touchStatus.left = true;
          }
        } else {
          // Cek apakah sentuhan pindah ke tombol lain
          if (isPointInButton(x, y, buttons.right)) {
            // Pindah dari kiri ke kanan
            player.moveLeft = false;
            buttons.left.active = false;
            touchStatus.left = false;
            
            player.moveRight = true;
            buttons.right.active = true;
            touchStatus.right = true;
            touchStatus.touchPoints[touchId] = 'right';
          } else if (isPointInButton(x, y, buttons.shoot)) {
            // Pindah dari kiri ke tembak
            player.moveLeft = false;
            buttons.left.active = false;
            touchStatus.left = false;
            
            buttons.shoot.active = true;
            touchStatus.shoot = true;
            touchStatus.touchPoints[touchId] = 'shoot';
            shoot();
          } else {
            // Sentuhan keluar dari semua tombol
            player.moveLeft = false;
            buttons.left.active = false;
            touchStatus.left = false;
            delete touchStatus.touchPoints[touchId];
          }
        }
      } else if (buttonType === 'right') {
        if (isPointInButton(x, y, buttons.right)) {
          if (!buttons.right.active) {
            player.moveRight = true;
            buttons.right.active = true;
            touchStatus.right = true;
          }
        } else {
          // Cek apakah sentuhan pindah ke tombol lain
          if (isPointInButton(x, y, buttons.left)) {
            // Pindah dari kanan ke kiri
            player.moveRight = false;
            buttons.right.active = false;
            touchStatus.right = false;
            
            player.moveLeft = true;
            buttons.left.active = true;
            touchStatus.left = true;
            touchStatus.touchPoints[touchId] = 'left';
          } else if (isPointInButton(x, y, buttons.shoot)) {
            // Pindah dari kanan ke tembak
            player.moveRight = false;
            buttons.right.active = false;
            touchStatus.right = false;
            
            buttons.shoot.active = true;
            touchStatus.shoot = true;
            touchStatus.touchPoints[touchId] = 'shoot';
            shoot();
          } else {
            // Sentuhan keluar dari semua tombol
            player.moveRight = false;
            buttons.right.active = false;
            touchStatus.right = false;
            delete touchStatus.touchPoints[touchId];
          }
        }
      } else if (buttonType === 'shoot') {
        if (isPointInButton(x, y, buttons.shoot)) {
          if (!buttons.shoot.active) {
            buttons.shoot.active = true;
            touchStatus.shoot = true;
            shoot();
          }
        } else {
          // Cek apakah sentuhan pindah ke tombol lain
          if (isPointInButton(x, y, buttons.left)) {
            // Pindah dari tembak ke kiri
            buttons.shoot.active = false;
            touchStatus.shoot = false;
            
            player.moveLeft = true;
            buttons.left.active = true;
            touchStatus.left = true;
            touchStatus.touchPoints[touchId] = 'left';
          } else if (isPointInButton(x, y, buttons.right)) {
            // Pindah dari tembak ke kanan
            buttons.shoot.active = false;
            touchStatus.shoot = false;
            
            player.moveRight = true;
            buttons.right.active = true;
            touchStatus.right = true;
            touchStatus.touchPoints[touchId] = 'right';
          } else {
            // Sentuhan keluar dari semua tombol
            buttons.shoot.active = false;
            touchStatus.shoot = false;
            delete touchStatus.touchPoints[touchId];
          }
        }
      }
    } else {
      // Jika sentuhan baru, cek tombol mana yang disentuh
      if (isPointInButton(x, y, buttons.left)) {
        player.moveLeft = true;
        buttons.left.active = true;
        touchStatus.left = true;
        touchStatus.touchPoints[touchId] = 'left';
      } else if (isPointInButton(x, y, buttons.right)) {
        player.moveRight = true;
        buttons.right.active = true;
        touchStatus.right = true;
        touchStatus.touchPoints[touchId] = 'right';
      } else if (isPointInButton(x, y, buttons.shoot)) {
        buttons.shoot.active = true;
        touchStatus.shoot = true;
        touchStatus.touchPoints[touchId] = 'shoot';
        shoot();
      }
    }
  }
}
// Fungsi untuk menangani event sentuh berakhir pada canvas
function handleTouchEnd(e) {
  e.preventDefault();
  
  // Proses semua sentuhan yang berakhir
  for (let i = 0; i < e.changedTouches.length; i++) {
    const touch = e.changedTouches[i];
    const touchId = touch.identifier;
    
    // Cek tombol mana yang dilepas
    const buttonType = touchStatus.touchPoints[touchId];
    
    if (buttonType === 'left') {
      player.moveLeft = false;
      buttons.left.active = false;
      touchStatus.left = false;
    } else if (buttonType === 'right') {
      player.moveRight = false;
      buttons.right.active = false;
      touchStatus.right = false;
    } else if (buttonType === 'shoot') {
      buttons.shoot.active = false;
      touchStatus.shoot = false;
    }
    
    // Hapus sentuhan dari daftar
    delete touchStatus.touchPoints[touchId];
  }
}
// Fungsi untuk mengecek apakah titik berada di dalam tombol
function isPointInButton(x, y, button) {
  const centerX = button.x + button.width / 2;
  const centerY = button.y + button.height / 2;
  const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
  
  return distance <= button.radius;
}
// Event listeners untuk sentuh pada canvas
canvas.addEventListener('touchstart', handleTouchStart);
canvas.addEventListener('touchmove', handleTouchMove);
canvas.addEventListener('touchend', handleTouchEnd);
canvas.addEventListener('touchcancel', handleTouchEnd);
// Kontrol keyboard untuk pengujian
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') {
    player.moveLeft = true;
    buttons.left.active = true;
    touchStatus.left = true;
  }
  if (e.key === 'ArrowRight') {
    player.moveRight = true;
    buttons.right.active = true;
    touchStatus.right = true;
  }
  if (e.key === ' ' || e.key === 'Spacebar') {
    buttons.shoot.active = true;
    touchStatus.shoot = true;
    shoot();
  }
});
document.addEventListener('keyup', (e) => {
  if (e.key === 'ArrowLeft') {
    player.moveLeft = false;
    buttons.left.active = false;
    touchStatus.left = false;
  }
  if (e.key === 'ArrowRight') {
    player.moveRight = false;
    buttons.right.active = false;
    touchStatus.right = false;
  }
  if (e.key === ' ' || e.key === 'Spacebar') {
    buttons.shoot.active = false;
    touchStatus.shoot = false;
  }
});
// Handle resize - UKURAN SAMA DENGAN MUSUH
window.addEventListener('resize', () => {
  canvas.width = container.clientWidth;
  canvas.height = container.clientHeight;
  
  // Update ukuran pemain
  player.width = getRelativeSize(8);
  player.height = getRelativeSize(8);
  player.speed = getRelativeSize(0.7);
  player.x = canvas.width / 2 - player.width / 2;
  player.y = canvas.height * 0.7;
  
  // Update posisi tombol
  buttons.left.x = 30;
  buttons.left.y = canvas.height - 90;
  
  buttons.right.x = canvas.width - 100;
  buttons.right.y = canvas.height - 90;
  
  buttons.shoot.x = canvas.width / 2 - 40;
  buttons.shoot.y = canvas.height - 90;
  
  // Reinitialize background elements
  initStars();
  initNebulae();
});
// Fungsi untuk memulai audio setelah interaksi pengguna
function initAudio() {
  document.removeEventListener('touchstart', initAudio);
  document.removeEventListener('click', initAudio);
  
  // Coba mainkan BGM dengan volume rendah
  try {
    const bgm = document.getElementById("bgm");
    bgm.volume = 0.3;
    bgm.play().catch(e => {
      console.log("Audio autoplay prevented:", e);
    });
  } catch (e) {
    console.log("Audio error:", e);
  }
}
// Tambahkan event listener untuk memulai audio setelah interaksi pertama
document.addEventListener('touchstart', initAudio, { once: true });
document.addEventListener('click', initAudio, { once: true });
// Inisialisasi background saat halaman dimuat
initStars();
initNebulae();
</script>
</body>
</html>